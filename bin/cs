#!/bin/bash

if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "cygwin" || "$OSTYPE" == "win32" ]]; then
    echo "ÈîôËØØÔºöÊ≠§ËÑöÊú¨ÈúÄË¶ÅÂú® Linux ÁéØÂ¢É‰∏≠ËøêË°å"
    exit 1
fi

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
export PROJECT_ROOT

source "$PROJECT_ROOT/lib/core.sh"

if ! command_exists dialog; then
    log_error "dialog Êú™ÂÆâË£ÖÔºåËØ∑ÂÖàËøêË°åÂÆâË£ÖËÑöÊú¨"
    exit 1
fi

main() {
    if [[ $# -gt 0 ]]; then
        case "$1" in
            update|u)
                load_module "update"
                module_update
                ;;
            version|v)
                echo "$PROJECT_NAME v$PROJECT_VERSION"
                ;;
            help|h)
                echo "Áî®Ê≥ï: cs [ÂëΩ‰ª§]"
                echo ""
                echo "ÂëΩ‰ª§:"
                echo "  (Êó†ÂèÇÊï∞)    ÂêØÂä®‰∏ªËèúÂçï"
                echo "  update, u   Êõ¥Êñ∞ËÑöÊú¨"
                echo "  version, v  ÊòæÁ§∫ÁâàÊú¨"
                echo "  help, h     ÊòæÁ§∫Â∏ÆÂä©"
                ;;
            *)
                log_error "Êú™Áü•ÂëΩ‰ª§: $1"
                echo "‰ΩøÁî® 'cs help' Êü•ÁúãÂèØÁî®ÂëΩ‰ª§"
                exit 1
                ;;
        esac
        exit 0
    fi
    
    if [[ -z "$TMUX" ]]; then
        local session_name="üêπ Hamster Script"
        if tmux has-session -t "$session_name" 2>/dev/null; then
            tmux new-window -t "$session_name" -n "‰∏ªËèúÂçï" "bash $PROJECT_ROOT/bin/cs; exec bash"
            tmux attach-session -t "$session_name"
            exit 0
        fi
    fi
    
    load_module "menu"
    show_main_menu
}

main "$@"
